name: Container Security and Quality

on:
  push:
    branches: [ master, main ]
    paths: 
      - 'docker/**'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'docker/**'
  schedule:
    # Run weekly security scans
    - cron: '0 0 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: synchronet-bbs

jobs:
  dockerfile-lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Lint Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: docker/Dockerfile
        failure-threshold: warning

  security-scan:
    runs-on: ubuntu-latest
    needs: dockerfile-lint
    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build image for scanning
      uses: docker/build-push-action@v5
      with:
        context: ./docker
        platforms: linux/amd64
        load: true
        tags: local/synchronet-bbs:scan
        cache-from: type=gha

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'local/synchronet-bbs:scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  container-structure-test:
    runs-on: ubuntu-latest
    needs: dockerfile-lint
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test image
      uses: docker/build-push-action@v5
      with:
        context: ./docker
        platforms: linux/amd64
        load: true
        tags: test/synchronet-bbs:latest
        cache-from: type=gha

    - name: Install container structure test
      run: |
        curl -LO https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64
        chmod +x container-structure-test-linux-amd64
        sudo mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test

    - name: Create container structure test config
      run: |
        cat > container-test.yaml << 'EOF'
        schemaVersion: 2.0.0
        fileExistenceTests:
        - name: 'Check entrypoint script exists'
          path: '/usr/local/bin/entrypoint.sh'
          shouldExist: true
          permissions: '-rwxr-xr-x'
        - name: 'Check sbbs home directory'
          path: '/home/sbbs'
          shouldExist: true
        commandTests:
        - name: 'Check platform architecture'
          command: 'uname'
          args: ['-m']
          expectedOutput: ['x86_64']
        - name: 'Check sbbs user exists'
          command: 'id'
          args: ['sbbs']
          exitCode: 0
        metadataTest:
          exposedPorts: ["23", "80", "443", "1123"]
          workdir: "/home/sbbs"
          user: "sbbs"
        EOF

    - name: Run container structure test
      run: |
        container-structure-test test --image test/synchronet-bbs:latest --config container-test.yaml
